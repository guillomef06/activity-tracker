name: Auto PR to Main

# Se d√©clenche quand une PR est ferm√©e sur dev
on:
  pull_request:
    types: [closed]
    branches:
      - dev

jobs:
  create-pr-to-main:
    # N'ex√©cute que si la PR a √©t√© merg√©e (pas juste ferm√©e)
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout dev branch
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # V√©rifie s'il existe d√©j√† une PR ouverte de dev vers main
          EXISTING_PR=$(gh pr list --base main --head dev --state open --json number --jq '.[0].number')
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "‚úÖ PR #$EXISTING_PR existe d√©j√† de dev vers main"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ùå Aucune PR existante de dev vers main"
          fi

      - name: Create PR to main
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # R√©cup√®re le titre et le corps de la PR qui vient d'√™tre merg√©e
          MERGED_PR_TITLE="${{ github.event.pull_request.title }}"
          MERGED_PR_NUMBER="${{ github.event.pull_request.number }}"
          MERGED_PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # Cr√©e le corps de la PR avec un heredoc
          PR_BODY=$(cat <<EOF
          ## üì¶ Release candidate from dev to main

          ### Derni√®re PR merg√©e
          - **PR #$MERGED_PR_NUMBER**: $MERGED_PR_TITLE
          - **Auteur**: @$MERGED_PR_AUTHOR

          ### ‚úÖ Validations dev
          - Tous les tests passent sur dev
          - Build de production valid√©
          - Linting OK

          ### üìã Checklist avant merge
          - [ ] V√©rifier que tous les tests passent
          - [ ] V√©rifier le build de production
          - [ ] V√©rifier qu'il n'y a pas de breaking changes
          - [ ] Release notes √† jour (si n√©cessaire)

          ---
          _Cette PR a √©t√© cr√©√©e automatiquement suite au merge de #$MERGED_PR_NUMBER sur dev_
          EOF
          )
          
          # Cr√©e la PR de dev vers main
          gh pr create \
            --base main \
            --head dev \
            --title "üöÄ Release: Merge dev to main" \
            --body "$PR_BODY"

      - name: Comment on merged PR
        if: steps.check-pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚úÖ Cette PR a √©t√© merg√©e sur \`dev\`<br>üöÄ Une PR automatique de \`dev\` vers \`main\` a √©t√© cr√©√©e pour d√©ploiement en production."

      - name: Update existing PR
        if: steps.check-pr.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          MERGED_PR_TITLE="${{ github.event.pull_request.title }}"
          MERGED_PR_NUMBER="${{ github.event.pull_request.number }}"
          
          gh pr comment ${{ steps.check-pr.outputs.pr_number }} \
            --body "‚úÖ Nouvelle PR merg√©e sur dev: #$MERGED_PR_NUMBER - $MERGED_PR_TITLE"
          
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "‚úÖ Cette PR a √©t√© merg√©e sur \`dev\`<br>‚ÑπÔ∏è La PR #${{ steps.check-pr.outputs.pr_number }} de \`dev\` vers \`main\` existe d√©j√† et a √©t√© mise √† jour."
