<div class="retroactive-tab-container">
  <mat-card class="info-card">
    <mat-card-header>
      <mat-card-title>{{ 'alliance.retroactive.title' | translate }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <p>{{ 'alliance.retroactive.description' | translate }}</p>
    </mat-card-content>
  </mat-card>

  <mat-card class="form-card">
    <mat-card-content>
      <form (ngSubmit)="onSubmit()" #retroForm="ngForm">
        
        <!-- Member Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'alliance.retroactive.selectMember' | translate }}</mat-label>
          <mat-select
            name="member"
            [ngModel]="selectedMember()"
            (ngModelChange)="selectedMember.set($event)"
            required>
            @for (member of members(); track member.id) {
              <mat-option [value]="member.id">
                {{ member.display_name || member.username }}
              </mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>person</mat-icon>
          <mat-hint>{{ 'alliance.retroactive.memberHint' | translate }}</mat-hint>
          <mat-error>{{ 'alliance.retroactive.memberRequired' | translate }}</mat-error>
        </mat-form-field>

        <!-- Week Selection -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'alliance.retroactive.selectWeek' | translate }}</mat-label>
          <mat-select
            name="week"
            [ngModel]="selectedWeeksAgo()"
            (ngModelChange)="selectedWeeksAgo.set($event)"
            required
          >
            @for (week of weekOptions(); track week.value) {
              <mat-option [value]="week.value">
                {{ week.label }} - {{ week.dateRange }}
              </mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>calendar_today</mat-icon>
          <mat-hint>{{ 'alliance.retroactive.weekHint' | translate }}</mat-hint>
        </mat-form-field>

        <!-- Activity Type Selection (Filtered by Week) -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'alliance.retroactive.selectActivity' | translate }}</mat-label>
          <mat-select
            name="activity"
            [ngModel]="selectedActivity()"
            (ngModelChange)="selectedActivity.set($event)"
            [disabled]="availableActivities().length === 0"
            required>
            @if (availableActivities().length === 0) {
              <mat-option disabled>
                {{ 'alliance.retroactive.noActivities' | translate }}
              </mat-option>
            }
            @for (activity of availableActivities(); track activity.value) {
              <mat-option [value]="activity.value">
                {{ activity.labelKey | translate }}
              </mat-option>
            }
          </mat-select>
          <mat-icon matPrefix>category</mat-icon>
          <mat-hint>{{ 'alliance.retroactive.activityHint' | translate }}</mat-hint>
          <mat-error>{{ 'alliance.retroactive.activityRequired' | translate }}</mat-error>
        </mat-form-field>

        <!-- Position Input -->
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>{{ 'alliance.retroactive.position' | translate }}</mat-label>
          <input
            matInput
            type="number"
            name="position"
            [ngModel]="position()"
            (ngModelChange)="position.set($event)"
            min="1"
            required/>
          <mat-icon matPrefix>emoji_events</mat-icon>
          <mat-hint>{{ 'alliance.retroactive.positionHint' | translate }}</mat-hint>
          <mat-error>{{ 'alliance.retroactive.positionRequired' | translate }}</mat-error>
        </mat-form-field>

        <!-- Points Preview -->
        @if (selectedActivity() && position() >= 1) {
          <div class="points-preview">
            <mat-icon>stars</mat-icon>
            <span class="points-label">{{ 'alliance.retroactive.pointsPreview' | translate }}:</span>
            <span class="points-value">{{ calculatedPoints() }}</span>
          </div>
        }

        <!-- Action Buttons -->
        <div class="form-actions">
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!canSubmit()">
            <mat-icon>add</mat-icon>
            @if (isSubmitting()) {
              {{ 'alliance.retroactive.submitting' | translate }}
            } @else {
              {{ 'alliance.retroactive.submit' | translate }}
            }
          </button>

          <button
            mat-button
            type="button"
            (click)="resetForm()"
            [disabled]="isSubmitting()">
            <mat-icon>refresh</mat-icon>
            {{ 'alliance.retroactive.reset' | translate }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>
</div>
